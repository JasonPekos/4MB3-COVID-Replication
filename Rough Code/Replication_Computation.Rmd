---
title: "Replication Exercise Computational Component"
author: "Zachary Levine"
date: "25/03/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

```{r}
library("deSolve")
library("tibble")

v_func <- function(t){
  return(0)
}
theN <- 270*10^9
make_params <- function(Beta = 0.4215,
                        gamma = 0.0876,
                        delta = 0.0028,
                        v = v_func,
                        N = theN,
                        q = 0,
                        nu = 0,
                        reinf = 0,
                        mu = 0,
                        natural_death = 0 
                        ){
  return(c("Beta" = Beta,
              "gamma" = gamma,
              "delta" = delta,
               "N" = N,
              "q" = q,
              "nu" = nu,
              "reinf" = reinf,
              "mu" = mu,
               "natural_death" = natural_death))
}
make_inits <- function(S = theN - I,
                    I = 7,
                    Q = 0,
                    R = 0,
                    D = 0,
                    N = theN){
    return(c(
      "S" = S,
      "I" = I,
      "Q" = Q,
      "R" = R,
      "D" = D))
}
make_beta <- function(betavals = c(0.0251, 0.0355, 0.122, 0.1698, 0.4488)){
  contact_matrix <- matrix(data = 5, nrow = 5, ncol = 5)
  Beta <- matrix(data = NA, nrow = 5, ncol = 5)
  for (i in 1:5){
    for (j in 1:5){
      Beta[[i,j]] <- betavals[i]*contact_matrix[i,j]
    }
  }
  return(Beta)
}

make_age_inits <- function(Nages = 5){
##Divide by Nages so that the total compartments sum up to the original population.
 state <- as.vector(replicate(make_inits(), n = Nages))/Nages
 names(state) <- paste0(rep(stateNames, 5), c(rep(1, 5), rep(2, 5), rep(3,5), rep(4,5), rep(5,5)))
 return(state)
}

paramNames <- c("Beta", "gamma", "delta", "N", "q", "nu", "reinf", "mu", "natural_death")
stateNames <- c("S",  "I", "Q", "R", "D")


run_sim <- function(params = make_params(),
                    use_age_structure = TRUE,
                    age_init = make_age_inits(),
                    init = make_inits(),
                    length = 150){
  if (use_age_structure){
    theModel <- function(time, state, parameters){
      S <- as.matrix(state[1:5])   
      I <- as.matrix(state[6:10])    
      Q <- as.matrix(state[11:15])  
      R <- as.matrix(state[16:20])   
      D <- as.matrix(state[21:25])
      with(as.list(c(parameters)), {
        v <- v_func(time)
        v_hat <- nu * v
      theBeta <-  make_beta()
      beta_I_sums <- numeric(5)
      for (i in 1:5){
        beta_I_sums[i] <- sum(theBeta[i,]%*%as.matrix(I/N))
      }
      dS <-  natural_death * (N - D) + reinf*R - (beta_I_sums + nu*v + mu)*S
      dI <- beta_I_sums * S - (q + mu) *I
      dQ <- q*I - (gamma + delta + mu) * Q
      dR <- gamma*Q + nu*v*S - (reinf+mu) * R
      dD <- delta * Q
      return(list(c(dS, dI, dQ, dR, dD)))
      })
    }
  }
  else{
      theModel <- function(time, state, parameters) {
      with(as.list(c(state, parameters)), {
        v <- v_func(time)
        v_hat <- nu * v
        dS <-  natural_death*(N - D) + reinf*R - (Beta*(I)/(N) + nu*v + mu)*S
        dI <- Beta*I*S / N - (q + mu) *I
        dQ <- q *I - (gamma + delta + mu) * Q
        dR <- gamma*Q + nu*v*S - (reinf+mu) * R
        dD <- delta * Q
        return(list(c(dS, dI, dQ, dR, dD)))
      })
    }
  }
time <- seq(from = 0, to = length, by = 1)
if (use_age_structure){
   res <- as.data.frame(ode(y = age_init,
                       times = time,
                        func = theModel,
                         parms = make_params()))
   colnames(res) <- c("time", paste0(rep(stateNames, 5),
                          c(rep(1, 5), rep(2, 5), rep(3,5), rep(4,5), rep(5,5))))
  
}

else{
  res <- as.data.frame(ode(y = init,
                       times = time,
                        func = theModel,
                         parms = params))
  colnames(res) <- c("time", stateNames)
}
return(res)
}
 

plot_sim <- function(use_age_structure =TRUE,
                     sim = run_sim(use_age_structure = use_age_structure),
                     drop = c("S", "R")){
  library("dplyr")
  library("ggpubr")
  library("tidyr")
  library("directlabels")
  library("tibble")
  ##Do this first.
  sim <- as_tibble(sim)
  if (!use_age_structure){
    sim$"Recovered" <- sim$R
    sim$"Cumulative Recovered" <- cumsum(sim$R)
    sim$"Death" <- sim$D
    sim$"Cumulative Death" <- cumsum(sim$D)
    ##Drop original columns
    sim <- sim[,!colnames(sim) %in% c("S", "D", "R", "Cumulative Recovered")]
  }
  else{
        sim <- sim[-seq(from = 2, to = length(sim), by = 5)]
  }
  ncurves <- length(sim)
  sim <- tidyr::pivot_longer(sim, col = !time)
  ##Rename columns.
  p <- ggscatter(data = sim, x= "time", y = "value", color = "name") +
    labs(title = "Pandemic simulation",
         x = "Time (days)",
         y = "Count")
  p
}
```

### References:
http://www.sherrytowers.com/sir_age.R